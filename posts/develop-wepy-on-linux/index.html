<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><link rel="icon" href="/favicon.png"><!-- <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"> --><!--SEO_BEGIN--><!-- Begin Jekyll SEO tag v2.7.1 --><title>在Linux上开发微信小程序 | ccat3z.xyz</title><meta name="generator" content="Jekyll v4.2.0"/><meta property="og:title" content="在Linux上开发微信小程序"/><meta name="author" content="ccat3z"/><meta property="og:locale" content="en_US"/><meta name="description" content="是一件痛苦的事情"/><meta property="og:description" content="是一件痛苦的事情"/><link rel="canonical" href="//ccat3z.xyz/posts/develop-wepy-on-linux/"/><meta property="og:url" content="//ccat3z.xyz/posts/develop-wepy-on-linux/"/><meta property="og:site_name" content="ccat3z.xyz"/><meta property="og:image" content="//ccat3z.xyz/images/2018-11-18-develop-wepy-on-linux/wechat.png"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2018-11-18T20:27:24+08:00"/><meta name="twitter:card" content="summary_large_image"/><meta property="twitter:image" content="//ccat3z.xyz/images/2018-11-18-develop-wepy-on-linux/wechat.png"/><meta property="twitter:title" content="在Linux上开发微信小程序"/><script type="application/ld+json">{"@type":"BlogPosting","datePublished":"2018-11-18T20:27:24+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"//ccat3z.xyz/posts/develop-wepy-on-linux/"},"author":{"@type":"Person","name":"ccat3z"},"image":"//ccat3z.xyz/images/2018-11-18-develop-wepy-on-linux/wechat.png","headline":"在Linux上开发微信小程序","dateModified":"2018-11-18T20:27:24+08:00","description":"是一件痛苦的事情","url":"//ccat3z.xyz/posts/develop-wepy-on-linux/","@context":"https://schema.org"}</script><!-- End Jekyll SEO tag --><!--SEO_END--><link href="/static/css/main.51661f66.chunk.css" rel="stylesheet"></head><body><div id="blog"></div><div id="blog-data"><div id="blog-data-content"><div class="post"><div class="post-info"><span class="post-id">/posts/develop-wepy-on-linux</span> <a href="/posts/develop-wepy-on-linux/" class="post-title">在Linux上开发微信小程序 </a><span class="post-date">18 Nov 2018</span><p class="post-description">是一件痛苦的事情</p><ul class="post-tags"><li><a href="/tag/mini-program/" class="post-tag">Mini Program</a></li><li><a href="/tag/wechat/" class="post-tag">WeChat</a></li><li><a href="/tag/tencent/" class="post-tag">Tencent</a></li></ul><img class="post-image" src="/images/2018-11-18-develop-wepy-on-linux/wechat.png"/></div><div class="content"><p>向来腾讯的用户产品在Linux上就很难使用, 甚至不放过开发工具. 自从微信推行小程序小游戏等”微信 OS”的产品后, 各种网络应用都急着要推出个小程序. 我作为一个吃瓜群众终于摆脱了巨大无比的国产APP, 嘴里喝着CoCo, 手上用着小程序给女朋友点单, 内心还是挺香的. 但写小程序的时候是真的<span style="font-size:150%">一点也开心不起来</span>. 花了一点时间研究了下怎么在Linux安心得写小程序. 这篇文章里主要用的是wepy, 如果用其他框架比如mpvue的也可以做一点参考. 以下是两个方法, 后者需要一台Windows机器.</p><h2 id="方法1-部分wine">方法1: 部分Wine</h2><p>细心的同学一定早就发现了, 微信小程序开发者工具用的是基于<code class="language-plaintext highlighter-rouge">NW.js</code>的框架以及<code class="language-plaintext highlighter-rouge">wcc</code>和<code class="language-plaintext highlighter-rouge">wcsc</code>两个小程序自己的编译工具. (然而都全局用了<code class="language-plaintext highlighter-rouge">NW.js</code>也不考虑下支持下Linux). 这样思路就很明显了: 得益于<code class="language-plaintext highlighter-rouge">wine-binfmt</code>我们可以不用显示得在命令行里指明<code class="language-plaintext highlighter-rouge">wine</code>直接运行Windows程序, 因此直接用Linux的<code class="language-plaintext highlighter-rouge">NW.js</code>再打包一遍就可以了.</p><p>这里有一个小问题就是开发工具中的<code class="language-plaintext highlighter-rouge">node-sync-ipc-nwjs</code>是针对Windows特供的, 要换成<code class="language-plaintext highlighter-rouge">node-sync-ipc</code>.</p><p>这个方法最早在由cytle在<a href="https://github.com/cytle/wechat_web_devtools">cytle/wechat_web_devtools</a>打包, 我针对ArchLinux的打包方式简化了一下上传在<a href="https://aur.archlinux.org/packages/wechat-devtools/">AUR wechat-devtools</a>上.</p><h2 id="方法2-远程编辑">方法2: 远程编辑</h2><s>在用方法1更新1.02.1811150的时候发现了一个奇怪的问题, 就是模拟器渲染的时候莫名其妙得找不到文件 (*.wxml not found) 一时找不到原因. (截至现在(2018/11/18)我注意到cytle解决了这个问题, 有空我去研究一下)</s><p>(是微信开发者工具自己的bug)</p><p>于是我又拿出了吃灰的Surface用作build机器. 通常都是在Windows上想办法远程编辑Linux服务器上的文件, 现在我们把方向反过来.</p><p>这里主要解决两个问题:</p><ol><li>Linux向Windows同步文件</li><li>wepy因为文件写入太慢导致的找不到文件bug <a href="https://github.com/Tencent/wepy/issues/1755">#1755</a></li></ol><h3 id="linux向windows同步文件">Linux向Windows同步文件</h3><p>Windows 10已经内置了OpenSSH. 因此我认为SSH一套的方法是最方便的. Windows 10上开启OpenSSH Server的方法我就不多废话了. 得注意的一点是<code class="language-plaintext highlighter-rouge">sshd_config</code>文件在OpenSSH正式版中在<code class="language-plaintext highlighter-rouge">C:\ProgramData\ssh\sshd_config</code>, 很多网上的文章已过时.</p><p>最先想到的是sshfs, 可以直接把Windows的目录挂载在本地, 这样就和平常一样, 也可以配合一些编译器插件或者IDE.</p><p>但这有个问题就是加载太慢, ls都要卡一下, 急性子都会很不爽. 想到VS 2019推出了远程协助, 我想VS Code也一定有人想办法做个插件出来. 找了一下果真有不少, 推荐几个好用的:</p><ol><li>Remote Workspace: 用了VS Code的filesystem接口, 问题是版本控制不认</li><li>ftp-sync: ftp/sftp自动同步, 只要Windows端开SSH服务器就能用了, 很方便</li><li>Sync-Rsync</li></ol><p>第一个和sshfs是相同的想法, 后两个是自动同步的插件. ftp-sync不需要什么特别配置, 写好就能用. 我就简单说下Syn-Rsync的配置方法. 给出我的配置文件</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="dl">"</span><span class="s2">sync-rsync.delete</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">sync-rsync.exclude</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">.git</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">.vscode</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">node_modules</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">dist</span><span class="dl">"</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">sync-rsync.remote</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ccat3z@surfaceZ:/mnt/c/Users/ccat3z/Documents/mp/</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">sync-rsync.args</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">-e ssh -p 6522</span><span class="dl">"</span><span class="p">],</span>
    <span class="dl">"</span><span class="s2">sync-rsync.onSave</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">sync-rsync.flags</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">crzv</span><span class="dl">"</span>
<span class="p">}</span>
</code></pre></div></div><ol><li><code class="language-plaintext highlighter-rouge">remote</code>地址我写的是wsl里的sshd, 所以是<code class="language-plaintext highlighter-rouge">/mnt/c</code>开头的</li><li>我没有用<code class="language-plaintext highlighter-rouge">sync-rsync.shell</code>而是在<code class="language-plaintext highlighter-rouge">args</code>里指定了remote shell, 临时解决下插件的问题</li><li>flags用<code class="language-plaintext highlighter-rouge">crzv</code>替代默认的, <code class="language-plaintext highlighter-rouge">-c</code>让rsync根据checksum来比较文件而不是修改时间和文件大小. (否则会导致Windows端的<code class="language-plaintext highlighter-rouge">wepy</code>整个项目重新编译, 因为<code class="language-plaintext highlighter-rouge">wepy</code>是根据修改时间来判断或者文件大小判断的)</li></ol><h3 id="warning-发现空文件-error-打开文件失败">[WARNING] 发现空文件 [Error] 打开文件失败</h3><p>这个问题在<code class="language-plaintext highlighter-rouge">wepy</code>的<a href="https://github.com/Tencent/wepy/issues/1755">issue #1755</a>中也有人提到, 是文件写入不够快导致的, 在主机上是小概率事件, 在远程编辑上就成了完全事件.</p><p>看<code class="language-plaintext highlighter-rouge">wepy</code>的源文件可以发现<code class="language-plaintext highlighter-rouge">wepy</code>的watch功能是通过<code class="language-plaintext highlighter-rouge">chokidar</code>实现的, 并且会读取<code class="language-plaintext highlighter-rouge">wepy.config.js</code>中的<code class="language-plaintext highlighter-rouge">watchOption</code>传给<code class="language-plaintext highlighter-rouge">chokidar</code>. 默认<code class="language-plaintext highlighter-rouge">chokidar</code>会在文件出现的那一刻触发<code class="language-plaintext highlighter-rouge">add</code> event, 参考<a href="https://github.com/paulmillr/chokidar#performance">paulmillr/chokidar</a>, 我们只要设置<code class="language-plaintext highlighter-rouge">awaitWriteFinish</code>即可解决问题.</p><p>在<code class="language-plaintext highlighter-rouge">wepy.config.js</code>里加入这个</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">watchOption</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">awaitWriteFinish</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div></div></div></div></div><div id="blog-data-page-pagination"></div><div id="blog-data-nav"><ul><li><a href="/" class="icon-home">home</a></li><li><a href="/posts/" class="icon-create">post</a></li></ul></div></div><script>const dataElement=document.getElementById("blog-data");dataElement&&dataElement.setAttribute("style","display: none;")</script><script src="/static/js/runtime-main.26ceb475.js"></script><script src="/static/js/2.4c4b9d9d.chunk.js"></script><script src="/static/js/main.ba7c982e.chunk.js"></script></body></html>