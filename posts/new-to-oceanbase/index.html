<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><link rel="icon" href="/favicon.png"><!-- <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"> --><!--SEO_BEGIN--><!-- Begin Jekyll SEO tag v2.7.1 --><title>OceanBase社区版入门指南 | ccat3z.xyz</title><meta name="generator" content="Jekyll v4.2.0"/><meta property="og:title" content="OceanBase社区版入门指南"/><meta name="author" content="ccat3z"/><meta property="og:locale" content="en_US"/><meta name="description" content="前一阵子参加了第一届OceanBase数据库大赛, 期间接触了MiniOB和OceanBase社区版. 本文对我开始学习OceanBase社区版时的经历做一个简单的介绍, 皆在帮助准备学习OceanBase源码的新人快速上手."/><meta property="og:description" content="前一阵子参加了第一届OceanBase数据库大赛, 期间接触了MiniOB和OceanBase社区版. 本文对我开始学习OceanBase社区版时的经历做一个简单的介绍, 皆在帮助准备学习OceanBase源码的新人快速上手."/><link rel="canonical" href="//ccat3z.xyz/posts/new-to-oceanbase/"/><meta property="og:url" content="//ccat3z.xyz/posts/new-to-oceanbase/"/><meta property="og:site_name" content="ccat3z.xyz"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2022-05-08T00:00:00+08:00"/><meta name="twitter:card" content="summary"/><meta property="twitter:title" content="OceanBase社区版入门指南"/><script type="application/ld+json">{"mainEntityOfPage":{"@type":"WebPage","@id":"//ccat3z.xyz/posts/new-to-oceanbase/"},"@type":"BlogPosting","author":{"@type":"Person","name":"ccat3z"},"headline":"OceanBase社区版入门指南","dateModified":"2022-05-08T00:00:00+08:00","datePublished":"2022-05-08T00:00:00+08:00","description":"前一阵子参加了第一届OceanBase数据库大赛, 期间接触了MiniOB和OceanBase社区版. 本文对我开始学习OceanBase社区版时的经历做一个简单的介绍, 皆在帮助准备学习OceanBase源码的新人快速上手.","url":"//ccat3z.xyz/posts/new-to-oceanbase/","@context":"https://schema.org"}</script><!-- End Jekyll SEO tag --><!--SEO_END--><link href="/static/css/main.4d801e45.chunk.css" rel="stylesheet"></head><body><div id="blog"></div><div id="blog-data"><div id="blog-data-content"><div class="post"><div class="post-info"><span class="post-id">/posts/new-to-oceanbase</span> <a href="/posts/new-to-oceanbase/" class="post-title">OceanBase社区版入门指南 </a><span class="post-date">08 May 2022</span><p class="post-description"></p><ul class="post-tags"><li><a href="/tag/oceanbase/" class="post-tag">OceanBase</a></li></ul></div><div class="content"><p>前一阵子参加了第一届OceanBase数据库大赛, 期间接触了<a href="https://github.com/oceanbase/miniob/">MiniOB</a>和<a href="https://github.com/oceanbase/oceanbase">OceanBase社区版</a>. 本文对我开始学习OceanBase社区版时的经历做一个简单的介绍, 皆在帮助准备学习OceanBase源码的新人快速上手.</p><h1 id="编译安装和部署">编译、安装和部署</h1><p>万事开头难. 所幸OceanBase社区版的构建工具非常”简洁”, 一个<code class="language-plaintext highlighter-rouge">build.sh</code>搞定了大部分操作. 首先是准备环境, OceanBase本身的构建脚本支持<a href="https://github.com/oceanbase/oceanbase/wiki/how_to_build#os-compatibility-list">大部分主流Linux发行版</a>. 但如果你希望在同一个系统上build和run, 还是建议你使用rpm体系的发行版, 因为部署工具obd只支持rpm体系.</p><h2 id="安装依赖">安装依赖</h2><p>编译OceanBase前只需要一些常见的工具链即可. 构建脚本会自己下载固定版本gcc和二进制依赖库等, 所以通常不用担心发行版之间的差异.</p><h3 id="redhat-based">Redhat Based</h3><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install </span>git wget rpm<span class="k">*</span> cpio make glibc-devel glibc-headers binutils m4
</code></pre></div></div><h3 id="debian-based">Debian Based</h3><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>git wget rpm rpm2cpio cpio make build-essential binutils m4
</code></pre></div></div><h2 id="编译oceanbase">编译OceanBase</h2><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./build.sh debug <span class="nt">--init</span> <span class="nt">--make</span>
</code></pre></div></div><p>只有第一次编译需要<code class="language-plaintext highlighter-rouge">--init</code>, <code class="language-plaintext highlighter-rouge">--init</code>会在<code class="language-plaintext highlighter-rouge">deps/3rd/</code>下载编译器和依赖库.</p><h2 id="部署oceanbase">部署OceanBase</h2><p>OceanBase启动参数会根据硬件配置变化, 还是交给<a href="https://github.com/oceanbase/obdeploy">OBD</a>部署比较方便. OBD目前只支持CentOS环境, 其他环境可能需要hack一下. 首先准备一个可用的OceanBase集群, 可以参考<a href="https://open.oceanbase.com/quickStart">快速开始</a>.</p><ol><li><p>添加OceanBase源</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> yum-utils
<span class="nb">sudo </span>yum-config-manager <span class="nt">--add-repo</span> https://mirrors.aliyun.com/oceanbase/OceanBase.repo
</code></pre></div></div></li><li><p>安装<code class="language-plaintext highlighter-rouge">ob-deploy</code>和<code class="language-plaintext highlighter-rouge">ob-client</code></p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> ob-deploy
</code></pre></div></div></li><li><p>部署一套OceanBase运行环境, 这里使用最简单的单节点配置为例 (需要替换<code class="language-plaintext highlighter-rouge">$OB_DEPLOY_NAME</code>):</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&gt;</span> deploy.yml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
oceanbase-ce:
  version: 3.1.0
  tag: ob-test
  servers:
  - 127.0.0.1
  global:
    home_path: /var/lib/oceanbase
    devname: eth0
    mysql_port: 2881
    rpc_port: 2882
    zone: zone1
    cluster_id: 1
    datafile_size: 10G
</span><span class="no">EOF

</span>obd cluster autodeploy <span class="s2">"</span><span class="nv">$OB_DEPLOY_NAME</span><span class="s2">"</span> <span class="nt">-c</span> deploy.yml
</code></pre></div></div></li><li><p>查看OceanBase运行状态</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>obd cluster display <span class="s2">"</span><span class="nv">$OB_DEPLOY_NAME</span><span class="s2">"</span>
</code></pre></div></div></li><li><p>创建测试租户</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>obd cluster tenant create <span class="s2">"</span><span class="nv">$OB_DEPLOY_NAME</span><span class="s2">"</span> <span class="nt">--tenant-name</span> <span class="nb">test
</span>obclient <span class="nt">-uroot</span>@test <span class="nt">-h127</span>.0.0.1 <span class="nt">-p2881</span>
</code></pre></div></div></li></ol><p>然后使用编译得到的<code class="language-plaintext highlighter-rouge">observer</code>替换集群使用的<code class="language-plaintext highlighter-rouge">observer</code>:</p><ol><li><p>找到集群使用的<code class="language-plaintext highlighter-rouge">observer</code>位置, 可以使用ps找.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps -ef | grep observer
</code></pre></div></div></li><li><p>停止OceanBase集群, 替换<code class="language-plaintext highlighter-rouge">observer</code>. 如果涉及多个节点, 需要一一替换:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>obd cluster stop <span class="s2">"</span><span class="nv">$OB_DEPLOY_NAME</span><span class="s2">"</span>
<span class="nb">cp</span> ./build_debug/src/observer/observer <span class="s2">"</span><span class="nv">$OB_CLUSTER_SERVER_BINARY_PATH</span><span class="s2">"</span>
</code></pre></div></div></li><li><p>最后重启OceanBase集群即可</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>obd cluster restart "$OB_DEPLOY_NAME"
</code></pre></div></div></li></ol><p>在比赛中我也写了一些用于远程开发、编译、测试的工具 (<a href="https://github.com/ccat3z/oceanbase-competition-toolset">ccat3z/oceanbase-competition-toolset</a>), 或许可以提供一些帮助.</p><h1 id="代码风格">代码风格</h1><p>在开始阅读OceanBase源码前, 我建议先看一下<a href="https://open.oceanbase.com/docs/oceanbase-code-style-guide/oceanbase-code-style-guide/V3.1.0/introduction">OceanBase 代码风格指南</a>. 尤其是被现代C++, GoLang, Java, C#等”惯坏”的同学们, 第一次看到大量的<code class="language-plaintext highlighter-rouge">if (OB_FAIL(...)) {} else {}</code>可能会比较困惑.</p><p>OceanBase为避免常见陷阱牺牲了编程复杂度, 强制单入口单出口, 禁止中途使用<code class="language-plaintext highlighter-rouge">return</code>, <code class="language-plaintext highlighter-rouge">goto</code>, <code class="language-plaintext highlighter-rouge">throw</code>等跳转指令. 这样能够让开发人员不容易忘记释放资源. 我们以最简单的顺序语句举例, 如果不限制单出口，可能会这么写 (GoLang玩家有被暗示到):</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">OB_SUCCESS</span><span class="p">;</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">do_something1</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCCESS</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(...);</span>
  <span class="n">log_error</span><span class="p">(...);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">do_something2</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCCESS</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(...);</span>
  <span class="n">log_error</span><span class="p">(...);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ... 更多代码</span>
</code></pre></div></div><p>限制单出口后, 能够防止在中途跳转时忘记释放资源:</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">OB_SUCCESS</span><span class="p">;</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">do_something1</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCCESS</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">log_error</span><span class="p">(...);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCCESS</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">do_something2</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCCESS</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">log_error</span><span class="p">(...);</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ... 更多代码</span>
<span class="n">free</span><span class="p">(...);</span>
<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</code></pre></div></div><p>上述代码仍然非常冗长，当有效代码只有两行。 因此OceanBase增加了一些<a href="https://open.oceanbase.com/docs/oceanbase-code-style-guide/oceanbase-code-style-guide/V3.1.0/common-macros">常用宏</a>用来精简代码:</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">OB_SUCCESS</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">do_something1</span><span class="p">()))</span> <span class="p">{</span>
  <span class="n">log_error</span><span class="p">(...);</span>
<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">do_somthing2</span><span class="p">()))</span> <span class="p">{</span>
  <span class="n">log_error</span><span class="p">(...);</span>
<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">OB_FAIL</span><span class="p">(...))</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="c1">// ...</span>
  <span class="c1">// ...</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="p">}</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">do_something1</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">OB_SUCCESS</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="n">free</span><span class="p">(...);</span>
<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</code></pre></div></div><p>我们可以在OceanBase中看到大量类似的<code class="language-plaintext highlighter-rouge">if else</code>的结构. 除了顺序语句, <a href="https://open.oceanbase.com/docs/oceanbase-code-style-guide/oceanbase-code-style-guide/V3.1.0/introduction">OceanBase 代码风格指南</a>中提到了很多语句的规范, 基本能覆盖大部分场景. 可以从中发现, OceanBase的代码风格确实复杂了一些, 刚开始理解代码会有少许阻力, 因此先快速浏览一遍风格指南能为读代码提供不小帮助. 一定有同学会和RAII, defer, GC等等做比较, 这点还是在你读OceanBase代码的过程中再评价吧.</p><h1 id="项目结构">项目结构</h1><p>首先来到项目的顶层目录, OceanBase社区版项目结构非常容易理解, 下面简单介绍.</p><ul><li><code class="language-plaintext highlighter-rouge">cmake/</code>和<code class="language-plaintext highlighter-rouge">build.sh</code>: 构建相关工具, 我们在第一节中已经用到了.</li><li><code class="language-plaintext highlighter-rouge">deps/</code>: 依赖库</li><li><code class="language-plaintext highlighter-rouge">rpm/</code>: RPM包打包脚本</li><li><code class="language-plaintext highlighter-rouge">tools/</code>: 一些开发和运维工具</li><li><code class="language-plaintext highlighter-rouge">test/</code>和<code class="language-plaintext highlighter-rouge">unittest/</code>: 集成测试和单元测试, 使用方法见<a href="https://github.com/oceanbase/oceanbase/wiki/how_to_test">如何运行测试</a></li><li><code class="language-plaintext highlighter-rouge">src/</code>: OceanBase源码<ul><li><code class="language-plaintext highlighter-rouge">share/</code>: 公共类</li><li><code class="language-plaintext highlighter-rouge">election/</code>: 集群的选举模块</li><li><code class="language-plaintext highlighter-rouge">rootserver/</code>: 集群的总控服务</li><li><code class="language-plaintext highlighter-rouge">archive/</code>: 日志归档组件, 用于备份恢复</li><li><code class="language-plaintext highlighter-rouge">clog/</code>: OceanBase版redo log</li><li><code class="language-plaintext highlighter-rouge">sql/</code>: SQL模块. SQL解析, 查询优化, 执行器等等</li><li><code class="language-plaintext highlighter-rouge">storage/</code>: 存储引擎</li><li><code class="language-plaintext highlighter-rouge">observer/</code>: OceanBase主进程, 系统入口</li></ul></li></ul><h1 id="下一步">下一步?</h1><p>至此已经做好了学习OceanBase源码的全部准备. 下一步可以参考<a href="https://www.bookstack.cn/read/OceanBase-3.1.1-zh/bc66c60a4672fd61.md">OceanBase官方教程</a>, 挑选感兴趣的模块作为切入点. 或者跟随<a href="https://www.zhihu.com/column/c_1505545451784400896">OceanBase 源码解读</a>系列文章学习. 如果有什么想改进的, 可以查阅<a href="https://github.com/oceanbase/oceanbase/wiki/how_to_contribute">OceanBase 开发者手册</a>, 成为一个Contributor!</p><h1 id="参考">参考</h1><ol><li><a href="https://open.oceanbase.com/docs/oceanbase-code-style-guide/oceanbase-code-style-guide/V3.1.0/introduction">OceanBase 代码风格指南</a></li><li><a href="https://www.zhihu.com/column/c_1505545451784400896">OceanBase 源码解读</a></li><li><a href="https://github.com/oceanbase/oceanbase/wiki/how_to_contribute">OceanBase 开发者手册</a></li></ol></div></div></div><div id="blog-data-page-pagination"></div><div id="blog-data-nav"><ul><li><a href="/" class="icon-home">home</a></li><li><a href="/posts/" class="icon-create">post</a></li></ul></div></div><script>const dataElement=document.getElementById("blog-data");dataElement&&dataElement.setAttribute("style","display: none;")</script><script src="/static/js/runtime-main.26ceb475.js"></script><script src="/static/js/2.4c4b9d9d.chunk.js"></script><script src="/static/js/main.583e2311.chunk.js"></script></body></html>