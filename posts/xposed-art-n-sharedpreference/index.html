<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title id="site-title">Xposed在Android N下尝试使用SharedPreference的解决方案 | ccat3z's blog</title> <link rel="icon" href="/favicon.png"> <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"> --> <!-- Begin Jekyll SEO tag v2.5.0 --> <title>Xposed在Android N下尝试使用SharedPreference的解决方案 | ccat3z’s blog</title> <meta name="generator" content="Jekyll v3.8.3" /> <meta property="og:title" content="Xposed在Android N下尝试使用SharedPreference的解决方案" /> <meta name="author" content="ccat3z" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="最近有开发者终于耐不住等待, 拿起art的源码就开始自己改. 虽然只是WIP, 但各路大神立刻就放出了卡刷包, 我也迫不及待得尝了把鲜. 不过很快就发现原来的SharedPreference已经不再适用, 这里简单介绍下我所使用的解决方法." /> <meta property="og:description" content="最近有开发者终于耐不住等待, 拿起art的源码就开始自己改. 虽然只是WIP, 但各路大神立刻就放出了卡刷包, 我也迫不及待得尝了把鲜. 不过很快就发现原来的SharedPreference已经不再适用, 这里简单介绍下我所使用的解决方法." /> <link rel="canonical" href="//ccat3z.xyz/posts/xposed-art-n-sharedpreference/" /> <meta property="og:url" content="//ccat3z.xyz/posts/xposed-art-n-sharedpreference/" /> <meta property="og:site_name" content="ccat3z’s blog" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-07-24T23:07:39+08:00" /> <script type="application/ld+json"> {"dateModified":"2017-07-24T23:07:39+08:00","datePublished":"2017-07-24T23:07:39+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"//ccat3z.xyz/posts/xposed-art-n-sharedpreference/"},"headline":"Xposed在Android N下尝试使用SharedPreference的解决方案","url":"//ccat3z.xyz/posts/xposed-art-n-sharedpreference/","author":{"@type":"Person","name":"ccat3z"},"description":"最近有开发者终于耐不住等待, 拿起art的源码就开始自己改. 虽然只是WIP, 但各路大神立刻就放出了卡刷包, 我也迫不及待得尝了把鲜. 不过很快就发现原来的SharedPreference已经不再适用, 这里简单介绍下我所使用的解决方法.","@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <link href="https://cdn.bootcss.com/material-design-icons/3.0.1/iconfont/material-icons.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/vuetify@1.1.14/dist/vuetify.min.css" rel="stylesheet"><link href="/css/blog.78161e4aee73db35bd05.css" rel="stylesheet"></head> <body> <div id="blog"></div> <div id="blog-data"> <div id="blog-data-content"><div class="post"> <div class="post-info"> <a href="/posts/xposed-art-n-sharedpreference/" class="post-title">Xposed在Android N下尝试使用SharedPreference的解决方案 </a> <span class="post-date">24 Jul 2017</span> </h2> <p class="post-short-description">Xposed亦可赛艇</p> <ul class="post-tags"> <li><a href="/tag/xposed" class="post-tag">Xposed</a></li> </ul> </div> <div class="content"> <p>最近有开发者终于耐不住等待, 拿起art的源码就开始自己改. 虽然只是WIP, 但各路大神立刻就放出了卡刷包, 我也迫不及待得尝了把鲜. 不过很快就发现原来的SharedPreference已经不再适用, 这里简单介绍下我所使用的解决方法.</p> <p>我们知道, Xposed是通过向目标apk"注入"片段来实现修改原程序功能的, 实际运行时是在目标apk下. 通常我们想通过app来控制一些Xposed插件的功能, 第一个想到的方便的工具就是SharedPreference, 但Android中, 每个apk都处于不同的用户下运行, 不能直接XSharedPreference获取对应设置. 在之前的Android版本中我们常常通过将SharedPreference设置为<code class="highlighter-rouge">MODE_WORLD_READABLE</code>来实现全用户可读:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getPreferenceManager</span><span class="o">().</span><span class="na">setSharedPreferencesMode</span><span class="o">(</span><span class="n">MODE_WORLD_READABLE</span><span class="o">);</span>
</code></pre></div></div> <p>在xposed hook段中使用:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">XSharedPreferences</span> <span class="n">xSharedPreferences</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XSharedPreferences</span><span class="o">(</span><span class="n">PACKAGE_NAME</span><span class="o">);</span>
<span class="n">xSharedPreferences</span><span class="o">.</span><span class="na">makeWorldReadable</span><span class="o">();</span>
</code></pre></div></div> <p>但在N中这个参数已经被禁用了(no longer supported), (M中是不推荐(deprecated)). 不过我们的想法大体上是不变的, 直接找SharedPreference的xml文件并全用户(组)Readable, 以PreferenceFragment为例, 在onPause中插入:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 放在super.onPause();之后</span>
<span class="c1">// 因为PreferenceFragment默认采用的是MODE_PRIVATE</span>
<span class="c1">// 或者getActivity().getApplicationInfo().dataDir + "/shared_prefs/"</span>
<span class="c1">//         + getPreferenceManager().getSharedPreferencesName() + ".xml"</span>
<span class="c1">// 当然会被IDE警告, 当然别忘了测试file exist</span>
<span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s">"/data/data/"</span> <span class="o">+</span> <span class="n">PACKAGE_NAME</span> <span class="o">+</span> <span class="s">"/shared_prefs/"</span> <span class="o">+</span> <span class="n">PACKAGE_NAME</span> <span class="o">+</span> <span class="s">"_preferences.xml"</span><span class="o">).</span><span class="na">setReadable</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</code></pre></div></div> <p>虽然解决了<code class="highlighter-rouge">MODE_WORLD_READABLE</code>, 不过这样在N中还是可能会无法工作. 在UNIX其他用户组下读取子文件需要该文件具备r的权限的同时还需要所有父文件夹具有x权限, 但在试用SDK 24以上作为targetSdkVersion的APP的data目录在N下都会被设置成700权限, 即其他用户组没法获取该data文件夹下的任何文件. 一个临时方便的解决方法是将targetSdkVerison设置成23或者更小, 另一个可能可行的方法(暂未测试)是在前面设置SharedPreference的xml的权限后将data目录设置Excecutable(<code class="highlighter-rouge">setExecutable</code>).</p> <p>完整的解决方案可以参考这个项目: <a href="https://github.com/c0ldcat/Hook-Method-Helper">Hook-Method-Helper</a>.</p> </div> </div></div> <div id="blog-data-page-pagination"></div> <div id="blog-data-nav"> <ul> <li> <a href="/" class="icon-home">home</a> </li> <li> <a href="/posts" class="icon-create">post</a> </li> <li> <a href="/projects" class="icon-code">projects</a> </li> <li> <a href="/tags" class="icon-bookmark">tags</a> </li> <li> <a href="/love" class="icon-favorite">love</a> </li> </ul> </div> <div id="blog-data-icp">沪ICP备18037676号</div> </div> <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.runtime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vuetify@1.1.14/dist/vuetify.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="/js/blog.78161e4aee73db35bd05.js"></script></body> </html>
